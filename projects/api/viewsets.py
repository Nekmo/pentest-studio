import os
import tarfile

from asciinema import asciicast
from asciinema.commands.cat import CatCommand
from django.http import StreamingHttpResponse
from django.views.static import serve
from django_filters.rest_framework import DjangoFilterBackend
from rest_framework import viewsets, filters
from rest_framework.decorators import action
from rest_framework.response import Response

from pentest_studio.api import BaseViewSetMixIn
from projects.api.serializers import ProjectSerializer, ActionSerializer, DetailProjectSerializer, \
    DetailActionSerializer
from projects.models import Project, Action


def serve_file(request, filepath):
    return serve(request, os.path.basename(filepath), os.path.dirname(filepath))


def asciinema_cat(file):
    with asciicast.open_from_url(file) as a:
        for t, _type, text in a.stdout_events():
            yield text


class ProjectViewSet(BaseViewSetMixIn, viewsets.ModelViewSet):
    """
    """
    queryset = Project.objects.all()
    serializer_class = ProjectSerializer
    filter_backends = (filters.OrderingFilter, filters.SearchFilter, DjangoFilterBackend)
    search_fields = ('name',)
    filter_fields = ('parent', 'created_at', 'updated_at')
    ordering_fields = filter_fields
    detail_serializer_class = DetailProjectSerializer


class ActionViewSet(BaseViewSetMixIn, viewsets.ModelViewSet):
    """
    """
    queryset = Action.objects.all()
    serializer_class = ActionSerializer
    filter_backends = (filters.OrderingFilter, filters.SearchFilter, DjangoFilterBackend)
    search_fields = ('name',)
    filter_fields = ('parent', 'parent', 'created_at', 'updated_at')
    ordering_fields = filter_fields
    detail_serializer_class = DetailActionSerializer

    @action(methods=['put'], detail=True)
    def worker_upload(self, request, pk):
        file_obj = request.data['file']
        instance: Action = self.get_object()
        directory = os.path.dirname(instance.get_data_directory())
        os.makedirs(directory, exist_ok=True)
        t = tarfile.open(fileobj=file_obj.file)
        t.extractall(directory)
        return Response(status=204)

    @action(methods=['get'], detail=True, url_path='asciinema.cast')
    def download_cast(self, request, pk):
        instance: Action = self.get_object()
        return serve_file(request, instance.get_terminal_path())

    @action(methods=['get'], detail=True)
    def terminal_output(self, request, pk):
        instance: Action = self.get_object()
        return StreamingHttpResponse(asciinema_cat(instance.get_terminal_path()))
