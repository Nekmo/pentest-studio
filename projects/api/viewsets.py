import glob
import os
import re
import tarfile
from typing import Type

import toml
from asciinema import asciicast
from asciinema.commands.cat import CatCommand
from django.conf import settings
from django.http import StreamingHttpResponse, Http404
from django.views.static import serve
from django_filters.rest_framework import DjangoFilterBackend
from rest_framework import viewsets, filters, mixins
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.serializers import Serializer

from pentest_studio.api import BaseViewSetMixIn
from projects.api.serializers import ProjectSerializer, ActionSerializer, DetailProjectSerializer, \
    DetailActionSerializer, PluginSetupSerializer, PluginSerializer, PluginShortcutArgSerializer, \
    PluginShortcutEnvSerializer, PluginShortcutSerializer
from projects.models import Project, Action


def serve_file(request, filepath):
    return serve(request, os.path.basename(filepath), os.path.dirname(filepath))


def asciinema_cat(file):
    with asciicast.open_from_url(file) as a:
        for t, _type, text in a.stdout_events():
            yield text


class ProjectViewSet(BaseViewSetMixIn, viewsets.ModelViewSet):
    """
    """
    queryset = Project.objects.all()
    serializer_class = ProjectSerializer
    filter_backends = (filters.OrderingFilter, filters.SearchFilter, DjangoFilterBackend)
    search_fields = ('name',)
    filter_fields = ('parent', 'created_at', 'updated_at')
    ordering_fields = filter_fields
    detail_serializer_class = DetailProjectSerializer


class ActionViewSet(BaseViewSetMixIn, viewsets.ModelViewSet):
    """
    """
    queryset = Action.objects.all()
    serializer_class = ActionSerializer
    filter_backends = (filters.OrderingFilter, filters.SearchFilter, DjangoFilterBackend)
    search_fields = ('name',)
    filter_fields = ('parent', 'parent', 'created_at', 'updated_at')
    ordering_fields = filter_fields
    detail_serializer_class = DetailActionSerializer

    @action(methods=['put'], detail=True)
    def worker_upload(self, request, pk):
        file_obj = request.data['file']
        instance: Action = self.get_object()
        directory = os.path.dirname(instance.get_data_directory())
        os.makedirs(directory, exist_ok=True)
        t = tarfile.open(fileobj=file_obj.file)
        t.extractall(directory)
        return Response(status=204)

    @action(methods=['get'], detail=True, url_path='asciinema.cast')
    def download_cast(self, request, pk):
        instance: Action = self.get_object()
        return serve_file(request, instance.get_terminal_path())

    @action(methods=['get'], detail=True)
    def terminal_output(self, request, pk):
        instance: Action = self.get_object()
        return StreamingHttpResponse(asciinema_cat(instance.get_terminal_path()))


class FileTomlViewSet(mixins.ListModelMixin, mixins.RetrieveModelMixin,
                      viewsets.GenericViewSet, viewsets.ViewSet):
    serializer_class: Type[Serializer] = None

    def get_directory_path(self) -> str:
        raise NotImplementedError

    def get_file(self, pk):
        return toml.load(open(os.path.join(self.get_directory_path(), pk), 'r'))

    def list_files(self):
        return os.listdir(self.get_directory_path())

    def get_queryset(self):
        return map(self.get_file, self.list_files())

    def get_object(self):
        lookup_url_kwarg = self.lookup_url_kwarg or self.lookup_field
        file_id = self.kwargs[lookup_url_kwarg]
        try:
            file = next(filter(lambda x: re.match('{}.*\.to?ml$'.format(re.escape(file_id)), x, re.IGNORECASE),
                               self.list_files()))
        except StopIteration:
            raise Http404
        return self.get_file(file)


class PluginViewSet(FileTomlViewSet):
    def get_directory_path(self):
        return settings.PLUGIN_DIRECTORY


class PluginSetupViewSet(PluginViewSet):
    serializer_class = PluginSetupSerializer


class PluginViewSet(PluginViewSet):
    serializer_class = PluginSerializer

    def get_file(self, pk):
        return dict(id=pk, **super().get_file(pk))


class PluginShortcutArgViewSet(PluginViewSet):
    serializer_class = PluginShortcutArgSerializer


class PluginShortcutEnvViewSet(PluginViewSet):
    serializer_class = PluginShortcutEnvSerializer


class PluginShortcutViewSet(PluginViewSet):
    serializer_class = PluginShortcutSerializer
