FROM python:3.9 as gunicorn-build
ENV PYTHONUNBUFFERED 1
ENV DJANGO_SETTINGS_MODULE "pentest_studio.settings.production"

RUN mkdir -p /app /static
COPY *.txt /tmp/
RUN pip install -r /tmp/requirements.txt
COPY compose/gunicorn/*.sh /
RUN chmod +x "/entrypoint.sh" "/start.sh"
WORKDIR /app
COPY . ./
RUN python manage.py collectstatic --noinput

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/start.sh"]


FROM node:16.4 as angular-build
ENV PATH /app/node_modules/.bin:$PATH
RUN mkdir /app
WORKDIR /app
COPY ui/package.json ui/package-lock.json ./
RUN npm i && ngcc
COPY ui ./
RUN ng build --prod


FROM nginx:1.21 as nginx-build

COPY --from=angular-build /app/dist/ /angular/
COPY --from=gunicorn-build /static/ /static/
ENTRYPOINT ["nginx", "-g", "daemon off;"]


FROM rabbitmq:3-management as nginx-build
RUN rabbitmq-plugins enable rabbitmq_prometheus
RUN rabbitmq-plugins enable rabbitmq_management
