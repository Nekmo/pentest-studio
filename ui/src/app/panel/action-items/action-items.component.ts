import {Component, Input, OnChanges, OnInit, SimpleChanges} from '@angular/core';
import {HttpClient} from "@angular/common/http";


function noCaseFilter(items, search) {
    if(!search || !items) {
        return items;
    }
    search = search.toLowerCase();
    return items.filter((x) => x.name.toLowerCase().indexOf(search) >= 0)
}


@Component({
    selector: 'action-items',
    templateUrl: './action-items.component.html',
    styleUrls: ['./action-items.component.scss']
})
export class ActionItemsComponent implements OnInit, OnChanges {

    @Input() projectId;
    @Input() actions;
    @Input() displayShortcuts: boolean = true;
    @Input() statuses: string[] = [];
    @Input() search: string = '';

    shortcuts: any[];
    _actions = [];
    _shortcuts = [];

    pluginShortcutUrl: string = '/api/projects/plugin_shortcuts/';

    constructor(private http: HttpClient) { }

    ngOnInit() {
        if(this.displayShortcuts) {
            this.setShortcuts();
        }
        this.setFilters();
    }

    ngOnChanges(changes: SimpleChanges): void {
        this.setFilters();
    }

    getFilteredActions(actions, filterStatuses = true) {
        if(this.statuses.length && filterStatuses) {
            actions = actions.filter((x) => this.statuses.indexOf(x.status) >= 0);
        }
        actions = noCaseFilter(actions, this.search);
        return actions;
    }

    setShortcuts() {
        this.http.get(this.pluginShortcutUrl).subscribe((data: any) => {
            this.shortcuts = data;
            this.setFilters();
        });
    }

    setFilters() {
        this._actions = this.getFilteredActions(this.actions);
        this._shortcuts = this.getFilteredActions(this.shortcuts, false);
    }

}
