import { Injectable } from '@angular/core';


const RETRY_TIMEOUT = 10 * 1000;


export interface WorkerMessageEvent {
    worker_id: number;
    message: any;
}
export type WorkerMessageListener = (event: WorkerMessageEvent) => void;

function sendEvent(listeners: WorkerMessageListener[], event: WorkerMessageEvent) {
    listeners.forEach((listener: WorkerMessageListener) => {
        listener(event);
    });
}


@Injectable({
    providedIn: 'root'
})
export class WorkerWebSocket {
    ws: WebSocket;
    metrics: {[metricName: string]: WorkerMessageListener[]} = {};
    updateModels: {[modelName: string]: WorkerMessageListener[]} = {};

    constructor() {
    }

    start() {
        this.createWebsocket();
    }

    sendMessage(data: any) {
        const jsonData: string = JSON.stringify(data);
        if (this.ws.readyState == 1) {
            this.ws.send(jsonData);
        } else {
            this.ws.addEventListener('open', (event) => {
                this.ws.send(jsonData);
            });
        }
    }

    createWebsocket() {
        this.ws = new WebSocket(`ws://${window.location.host}/ws/workers/`);
        this.ws.addEventListener('message', (event: MessageEvent<WorkerMessageEvent>) => {
            const data = JSON.parse(event.data as unknown as string);
            if (data.message.metric_name && this.metrics[data.message.metric_name] !== undefined) {
                sendEvent(this.metrics[data.message.metric_name], data);
            }
            if (data.message.update_model && this.updateModels[data.message.update_model] !== undefined) {
                sendEvent(this.updateModels[data.message.update_model], data);
            }
        });
        this.ws.onerror = (() => {
            setTimeout(() => {
                this.createWebsocket();
            }, RETRY_TIMEOUT);
        });
    }

    metricSubscribe(metricName: string, fn: WorkerMessageListener) {
        if (this.metrics[metricName] === undefined) {
            this.metrics[metricName] = [];
        }
        this.metrics[metricName].push(fn);
    }

    updateModelSubscribe(modelName: string, fn: WorkerMessageListener) {
        if (this.updateModels[modelName] === undefined) {
            this.updateModels[modelName] = [];
        }
        this.metrics[modelName].push(fn);
    }

    close(): void {
        this.metrics = {};
        this.ws.close();
    }
}
