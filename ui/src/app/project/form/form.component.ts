import {Component, Input, OnChanges, OnInit, SimpleChanges} from '@angular/core';
import {FormControl, FormGroup} from "@angular/forms";
import {HttpClient} from "@angular/common/http";
import {getCookie} from "../../httpUtils";
import {Router} from "@angular/router";

@Component({
    selector: 'project-form',
    templateUrl: './form.component.html',
    styleUrls: ['./form.component.scss']
})
export class FormComponent implements OnInit, OnChanges {

    @Input() instanceId: number;
    instance: any = null;
    url = '/api/projects/projects/';
    form = new FormGroup({
      name: new FormControl(''),
      url: new FormControl(''),
      type: new FormControl(''),
      description: new FormControl(''),
      data: new FormControl(''),
    });

    constructor(private http: HttpClient, private router: Router) { }

    ngOnInit() {
    }

    ngOnChanges(changes: SimpleChanges): void {
        this.setInstance();
    }


    setInstance() {
        this.http.get(`${this.url}${this.instanceId}`).subscribe((data) => {
            this.instance = data;
            for (let key in data) {
                let control = this.form.controls[key];
                if(control) {
                    control.patchValue(data[key]);
                }
            }
        });
    }

    save(data) {
        let url = this.url + (this.instanceId ? `/${this.instanceId}/` : '');
        this.http[(this.instanceId ? 'put' : 'post')](
            url, data, {headers: {'X-CSRFToken': getCookie('csrftoken') || ''}}
        ).subscribe((project) => {
          this.router.navigate(['/projects', project['id']])
        });
    }
}
