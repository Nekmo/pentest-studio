import {AfterViewInit, Component, OnInit, ViewChild} from '@angular/core';
import {HttpClient} from "@angular/common/http";
import {Router} from "@angular/router";
import {Project, ProjectApi} from "../../shared/api.service";
import {Page} from "angular-django";
import {MatInput} from "@angular/material/input";
import {Subject} from "rxjs";
import {debounceTime} from "rxjs/operators";

@Component({
  selector: 'app-list',
  templateUrl: './list.component.html',
  styleUrls: ['./list.component.scss']
})
export class ListComponent implements OnInit, AfterViewInit {

  url = '/api/projects/projects/';
  projects: any;
  searchQuery: string = '';
  debouncedUpdateResults = new Subject();
  debounceTimeUpdateResults: number = 200;

  @ViewChild('searchInput') searchInput: MatInput;

  constructor(private http: HttpClient,
              private router: Router,
              private projectApi: ProjectApi) { }

  ngOnInit() {
    this.setProjects();

    this.debouncedUpdateResults.pipe(
      debounceTime(this.debounceTimeUpdateResults),
      // TODO: takeUntil(this.destroy$),
    ).subscribe(() => {
      this.setProjects();
    });
  }

  ngAfterViewInit() {
  }

  setProjects() {
    this.projectApi.search(this.searchQuery).list().subscribe((projects: Page<Project>) => this.projects = projects);
  }

  createProjectClick() {
    this.router.navigateByUrl(`/projects/create`);
  }

}
