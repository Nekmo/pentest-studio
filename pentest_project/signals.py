from django.db.models.signals import post_save
from django.dispatch import receiver

from pentest_project.models import Action, Project
from pentest_project.plugins import PluginCollections, render_shortcut_command


@receiver(post_save, sender=Action)
def update_is_last_action_plugin(sender, instance: Action, created: bool, **kwargs):
    if not created or not instance.plugin:
        return
    Action.objects\
        .filter(plugin=instance.plugin, is_last=True)\
        .exclude(pk=instance.pk).update(is_last=False)


@receiver(post_save, sender=Project)
def create_actions_from_collections(sender, instance: Project, created: bool, **kwargs):
    if not created or not instance.type:
        return
    for plugin_shortcut in PluginCollections().plugin_shortcuts_by_type(instance.type):
        action: Action = Action.objects.create(
            name=plugin_shortcut.name,
            project=instance,
            plugin=plugin_shortcut.full_id,
            command=render_shortcut_command(plugin_shortcut.command, instance)
        )
        action.run_terminal()
