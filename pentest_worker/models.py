from uuid import uuid4

from django.conf import settings
from django.contrib.auth import get_user_model
from django.db import models

# Create your models here.
from rest_framework.authtoken.models import Token

from model_extras.models import DateModel


class Server(DateModel):
    name = models.CharField(max_length=80)
    url = models.URLField()
    country = models.CharField(max_length=3)
    ip = models.GenericIPAddressField(blank=True, null=True)
    user = models.ForeignKey(get_user_model(), on_delete=models.CASCADE)

    @property
    def is_active(self):
        return self.user.is_active

    @property
    def user_token(self):
        return Token.objects.get(user=self.user).key

    def save(self, *args, **kwargs):
        if not self.pk:
            user = get_user_model().objects.create(
                username=uuid4().hex,
            )
            Token.objects.create(user=user)
            self.user = user
        return super().save(*args, **kwargs)
