import os
from logging import getLogger

import requests
from django.conf import settings
from django.urls import reverse

from pentest_worker.compress import create_memory_tar
from pentest_worker.config import get_worker_config

logger = getLogger(__name__)


def get_client_ip(request):
    x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
    if x_forwarded_for:
        ip = x_forwarded_for.split(',')[0]
    else:
        ip = request.META.get('REMOTE_ADDR')
    return ip


def upload_worker_data(term_name):
    directory = os.path.join(settings.WORKER_ACTIONS_TEMP_DIRECTORY, term_name)
    tar = create_memory_tar(directory)
    url = '{}{}'.format(settings.PENTEST_STUDIO_URL.rstrip('/'),
                        reverse('action-worker-upload', kwargs={'pk': term_name}))
    requests.put(url, files={'file': tar},
                 headers={'Authorization': 'Token {key}'.format(**get_worker_config())})


def block_task(term_name):
    url = '{}{}'.format(settings.PENTEST_STUDIO_URL.rstrip('/'),
                        reverse('action-block-task', kwargs={'pk': term_name}))
    resp = requests.post(url, headers={'Authorization': 'Token {key}'.format(**get_worker_config())})
    return resp.json()
