import os
import socket

import requests
from django.conf import settings
from django.urls import reverse


def get_server_name():
    return settings.WORKER_NAME or socket.gethostname()


def get_ip_info():
    return requests.get('http://ipinfo.io/json').json()


def get_worker_token():
    if not os.path.lexists(settings.PENTEST_WORKER_TOKEN_FILE):
        return False
    with open(settings.PENTEST_WORKER_TOKEN_FILE, 'r') as f:
        return f.read().strip()


def register_worker():
    ip_info = get_ip_info()
    r = requests.post('{}{}'.format(settings.PENTEST_STUDIO_URL, reverse('server-list')), {
        'name': get_server_name(),
        'ip': ip_info['ip'],
        'country': ip_info['country'],
    })
    r.raise_for_status()
    # TODO: return secret api token using AES
