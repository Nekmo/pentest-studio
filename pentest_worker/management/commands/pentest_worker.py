import os
from logging import getLogger

from django.conf import settings
from django.core.management.base import BaseCommand

from pentest_worker.workers.config import get_worker_config, Config
from pentest_worker.workers.metrics import MonitorThread
from pentest_worker.workers.terminal import start_terminal_webserver, Plugins

logger = getLogger('pentest_worker')


class Command(BaseCommand):
    help = ''

    def add_arguments(self, parser):
        parser.add_argument('--address', type=str, default='localhost')
        parser.add_argument('--port', type=int, default=8700)
        parser.add_argument('--worker-dir', type=str, default=None)

    def handle(self, *args, **options):
        worker_dir = options['worker_dir'] or settings.WORKER_DIR
        os.environ['WORKER_DIR'] = worker_dir
        config: Config = get_worker_config()
        Plugins().install_all()
        logger.info(f'Started as worker %d', config['id'])
        loop, term_manager = start_terminal_webserver(
            options['address'], options['port']
        )
        MonitorThread(settings.PENTEST_STUDIO_URL.rstrip('/') + '/ws/workers/', term_manager).start()
        loop.start()
